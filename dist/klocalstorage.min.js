/*
**
**  klocalstorage
**  =============
**
**  Version 1.0.3
**
**  Brought to you by
**  https://www.kycosoftware.com
**
**  Copyright 2015 Cornelius Weidmann
**
**  Distributed under the GPL
**
*/

"use strict";var klocalstorage={}||klocalstorage;klocalstorage.JQUERY_URL="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js";klocalstorage.JSONEDITOR_URL="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/4.2.1/jsoneditor.min.js";klocalstorage.JSONEDITOR_STYLE_URL="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/4.2.1/jsoneditor.min.css";klocalstorage.STYLE=document.getElementById("klocalstorage_style");klocalstorage.SCRIPT=document.getElementById("klocalstorage_script");klocalstorage.ERROR_MSG="An error occurred while getting the required dependencies.";klocalstorage.editor={};klocalstorage.init=function(){var e='<div id="klocalstorage_trigger">+</div>';var o='<div id="klocalstorage"></div>';var t='<div id="klocalstorage_overlay"></div>';$("body").append(e,o,t);klocalstorage.getLatest();klocalstorage.attachMarkupHandlers();$("#klocalstorage_overlay").click(function(){$("#klocalstorage_trigger, #klocalstorage, #klocalstorage_overlay").toggleClass("active");$("body").toggleClass("klocalstorage_activated");if(!$("#klocalstorage_trigger").hasClass("active")){$("#klocalstorage_trigger").html("+")}});$("#klocalstorage_trigger").click(function(){$(this).toggleClass("active");$("body").toggleClass("klocalstorage_activated");if($(this).hasClass("active")){$(this).html("-");klocalstorage.getLatest();klocalstorage.attachMarkupHandlers()}else{$(this).html("+")}$("#klocalstorage, #klocalstorage_overlay").toggleClass("active")})};klocalstorage.getLatest=function(){var e="";var o={};var t={};var a=localStorage.length;var l,r,s,c;var i={mode:"tree",modes:["tree","text"]};for(l=0;l<a;l++){e+='<h5 data-index="'+l+'">'+localStorage.key(l)+'<button action="delete">Delete</button><button action="save">Save</button></h5>';e+='<div data-index="'+l+'"></div>'}e+='<h5 data-index="'+(l+1)+'">// Other items</h5>';e+='<div data-index="'+(l+1)+'"></div>';e+='<h5 data-index="'+(l+2)+'">// Raw localStorage</h5>';e+='<div data-index="'+(l+2)+'"></div>';$("#klocalstorage").html(e);for(l=0;l<a;l++){r="";s=localStorage.key(l);c=localStorage.getItem(s);klocalstorage.editor["_"+l]=new JSONEditor($('#klocalstorage div[data-index="'+l+'"]')[0],i);try{r=JSON.parse(c)}catch(n){r=c}if(typeof r!=="object"){o[s]=r;$('#klocalstorage div[data-index="'+l+'"], #klocalstorage h5[data-index="'+l+'"]').remove()}else{klocalstorage.editor["_"+l].set(r)}t[s]=r}klocalstorage.editor["_"+(l+1)]=new JSONEditor($('#klocalstorage div[data-index="'+(l+1)+'"]')[0],i);klocalstorage.editor["_"+(l+2)]=new JSONEditor($('#klocalstorage div[data-index="'+(l+2)+'"]')[0],i);klocalstorage.editor["_"+(l+1)].set(o);klocalstorage.editor["_"+(l+2)].set(t)};klocalstorage.attachMarkupHandlers=function(){var e=function(e){var o=$(this).parent().data("index");var t=localStorage.key(o);var a;e.stopImmediatePropagation();try{a=klocalstorage.editor["_"+o].get();localStorage.setItem(t,JSON.stringify(a));$(this).before('<span class="klocalstorage_msg">Saved!</span>');$("#klocalstorage h5 .klocalstorage_msg").fadeOut(1e3,function(){$(this).remove()})}catch(l){$(this).before('<span class="klocalstorage_msg">Error! Must be String, Number, Array or Object!</span>');$("#klocalstorage h5 .klocalstorage_msg").fadeOut(5e3,function(){$(this).remove()})}};var o=function(o){var t=$(this).parent().data("index");var a=klocalstorage.editor["_"+t].get();var l=localStorage.key(t);o.stopImmediatePropagation();localStorage.removeItem(l);$(this).prop("disabled",true).siblings('button[action="save"]').off("click").html("Restore").attr("action","restore").on("click",function(o){o.stopImmediatePropagation();localStorage.setItem(l,JSON.stringify(a));$(this).attr("action","save").html("Save").off("click").on("click",e).before('<span class="klocalstorage_msg">Restored!</span>').siblings('button[action="delete"]').prop("disabled",false);$("#klocalstorage h5 .klocalstorage_msg").fadeOut(1e3,function(){$(this).remove()})});$(this).before('<span class="klocalstorage_msg">Deleted!</span>');$("#klocalstorage h5 .klocalstorage_msg").fadeOut(1e3,function(){$(this).remove()})};$("#klocalstorage h5").off("click").on("click",function(){$(this).toggleClass("active").next("div").toggleClass("active")});$('#klocalstorage h5 button[action="save"]').off("click").on("click",e);$('#klocalstorage h5 button[action="delete"]').off("click").on("click",o)};klocalstorage.corsRequest=function(e,o,t,a,l){var r;if(XMLHttpRequest){r=new XMLHttpRequest;if("withCredentials"in r){r.open(o,e,true);r.onerror=l;r.onreadystatechange=function(){if(r.readyState===4){if(r.status>=200&&r.status<400){a(r.responseText)}else{l()}}};r.send(t)}}else if(XDomainRequest){r=new XDomainRequest;r.open(o,e);r.onerror=l;r.onload=function(){a(r.responseText)};r.send(t)}else{l()}};klocalstorage.appendScript=function(e,o,t){t=e.createElement("script");t.async=1;t.innerHTML=o;klocalstorage.SCRIPT.parentNode.insertBefore(t,klocalstorage.SCRIPT)};klocalstorage.appendStyle=function(e,o){o=e.createElement("link");o.rel="stylesheet";o.href=klocalstorage.JSONEDITOR_STYLE_URL;klocalstorage.STYLE.parentNode.insertBefore(o,klocalstorage.STYLE)};klocalstorage.build=function(){if(typeof jQuery==="undefined"&&typeof JSONEditor==="undefined"){klocalstorage.corsRequest(klocalstorage.JQUERY_URL,"GET","",function(e){klocalstorage.appendScript(document,e);klocalstorage.corsRequest(klocalstorage.JSONEDITOR_URL,"GET","",function(e){klocalstorage.appendScript(document,e);klocalstorage.corsRequest(klocalstorage.JSONEDITOR_STYLE_URL,"GET","",function(e){klocalstorage.appendStyle(document,e);klocalstorage.init()},function(){console.error(klocalstorage.ERROR_MSG)})},function(){console.error(klocalstorage.ERROR_MSG)})},function(){console.error(klocalstorage.ERROR_MSG)})}if(typeof jQuery==="undefined"&&typeof JSONEditor!=="undefined"){klocalstorage.corsRequest(klocalstorage.JQUERY_URL,"GET","",function(e){klocalstorage.appendScript(document,e);klocalstorage.init()},function(){console.error(klocalstorage.ERROR_MSG)})}if(typeof jQuery!=="undefined"&&typeof JSONEditor==="undefined"){klocalstorage.corsRequest(klocalstorage.JSONEDITOR_URL,"GET","",function(e){klocalstorage.appendScript(document,e);klocalstorage.corsRequest(klocalstorage.JSONEDITOR_STYLE_URL,"GET","",function(e){klocalstorage.appendStyle(document,e);klocalstorage.init()},function(){console.error(klocalstorage.ERROR_MSG)})},function(){console.error(klocalstorage.ERROR_MSG)})}if(typeof jQuery!=="undefined"&&typeof JSONEditor!=="undefined"){klocalstorage.init()}}();
